<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>CDLM_GRAPH</title>
	
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/cdlm.css" type="text/css" />
	
		<script src="lib/jquery.js"></script>
		<script src="lib/sigma.min.js"></script>
		<script src="lib/sigma.parseGexf.js"></script>
		<script src="lib/sigma.forceatlas2.js"></script>
		
	</head>
	
	<body>
		<div class="buttons-container">
			<button class="btn" id="stop-layout">Start Layout</button>
			<button class="btn" id="rescale-graph">Rescale Graph</button>
		</div>
		<div id="mygraph"></div>
	</body>
	
	<script type="text/javascript">
		function init_graph() {
			// Instanciate sigma.js and customize rendering :
			var sigInst = sigma.init(document.getElementById('mygraph')).drawingProperties({
				defaultLabelColor: '#fff',
				defaultLabelSize: 12,
				defaultLabelBGColor: '#fff',
				defaultLabelHoverColor: '#000',
				labelThreshold: 4,
				defaultEdgeType: 'curve'
			}).graphProperties({
				minNodeSize: 1,
				maxNodeSize: 20,
				minEdgeSize: 1,
				maxEdgeSize: 1,
			}).mouseProperties({
				maxRatio: 32
			});
		
			// Parse a GEXF encoded file to fill the graph
			// (requires "sigma.parseGexf.js" to be included)
			sigInst.parseGexf('data/graph.gexf');
			// Draw the graph :
			sigInst.draw();
			
			var getCat = function(n) {
				return n['attr']['attributes'][0]['val'];
			};
			var greyColor = '#666';
			// Over
			sigInst.bind('overnodes',function(event){
				//console.log(event.content);
				var seln = sigInst.getNodes(event.content);
				selcat = getCat(seln[0]);
				if(selcat=="personne"){
					neighbors = {};
					sigInst.iterEdges(function(e){
						if(event.content!=e.source && event.content!=e.target) {
							if(!e.attr['grey']){
								e.attr['true_color'] = e.color;
								e.color = greyColor;
								e.attr['grey'] = 1;
							}
						}else{
							e.color = e.attr['grey'] ? e.attr['true_color'] : e.color;
							e.attr['grey'] = 0;
							neighbors[e.source] = 1;
							neighbors[e.target] = 1;
						}
					}).iterNodes(function(n){
						if(!neighbors[n.id]){
							if(!n.attr['grey']){
								n.attr['true_color'] = n.color;
								n.color = greyColor;
								n.attr['grey'] = 1;
								n.hidden = 1;
							}
						}else{
						n.color = n.attr['grey'] ? n.attr['true_color'] : n.color;
						n.attr['grey'] = 0;
						}
					}).draw(2,2,2);
				} else {
					sigInst.iterNodes(function(n){
						if(getCat(n)!=selcat && getCat(n)!="personne") {
							n.attr['true_color'] = n.color;
							n.color = greyColor;
							n.attr['grey'] = 1;
							n.hidden = 1;
						} else {
							n.color = n.attr['grey'] ? n.attr['true_color'] : n.color;
							n.attr['grey'] = 0;
						}
					}).draw(2,2,2);
				}
			// Out
			}).bind('outnodes',function(){
				if(selcat=="personne"){
					sigInst.iterEdges(function(e){
						e.color = e.attr['grey'] ? e.attr['true_color'] : e.color;
						e.attr['grey'] = 0;
					}).iterNodes(function(n){
						n.color = n.attr['grey'] ? n.attr['true_color'] : n.color;
						n.attr['grey'] = 0;
						n.hidden = 0;
					}).draw(2,2,2);			
				} else {
					sigInst.iterNodes(function(n){
						n.color = n.attr['grey'] ? n.attr['true_color'] : n.color;
						n.attr['grey'] = 0;
						n.hidden = 0;
					}).draw(2,2,2);
				}
			});
			
			return sigInst;
		}
		
		$(document).ready(function(){
			var sigInst = init_graph();;
			var isRunning = false;

			$("#stop-layout").on("click", function(u) {
				if(isRunning){
					isRunning = false;
					sigInst.stopForceAtlas2();
					$('#stop-layout').text('Start Layout');
				}else{
					console.log("starting layout");
					isRunning = true;
					sigInst.startForceAtlas2();
					$('#stop-layout').text('Stop Layout');
				}
			});
			$("#rescale-graph").on("click", function(u) {
				sigInst.position(0,0,1).draw();
			});
		});
	</script>
	
</html>
