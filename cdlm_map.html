<!DOCTYPE html>
<html>
<head>
		<meta charset="UTF-8" />
		<title>CDLM_MAP</title>
		
		<script src="lib/jquery.js"></script>
		<script src="lib/d3.v2.min.js"></script>
		<script src="lib/mapbox.js"></script>
		
		<link href='http://fonts.googleapis.com/css?family=Text+Me+One|Merienda|Roboto' rel='stylesheet' type='text/css'>
		<link href='http://api.tiles.mapbox.com/mapbox.js/v0.6.4/mapbox.css' rel='stylesheet' />
		<link rel="stylesheet" href="css/cdlm.css" type="text/css" />
		
		<!--<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />-->
</head>
<body>
<div id='map'></div>
<script type="text/javascript">
	
	function folly() {
		var f = {}, bounds, feature;
		var div = d3.select(document.body)
			.append("div").attr('class', 'd3-vec');
		f.parent = div.node();
/*
		var svgcarre = div.append('svg')
			.attr("width","200")
			.attr("height","200")
			.style("margin-left","0px")
			.style("margin-top","0px");
*/
		var svgmap = div.append('svg');
		
		var panelW = 230;
		var typeH = 36;
		var marg = 5;
		
		// CARRES
		var baseR = 40;
		var baseH = 40;
		var masR = panelW/2-baseR;
		var panelH = typeH+2*baseR;
		var cX = panelW/2;
		var cY = typeH+baseR;
		var carreM = 10;
		var imSize = baseR*2;

		// NGRAMS
		var minNgramSize = 11;
		var maxNgramSize = 27;
		var minPointSize = 1.5;
		var maxPointSize = 9;
		
		var typename = div.append("div").attr("id","typename")
			.style("top","0px")
			.style("left","0px")
			.style("width",panelW-4*marg+"px")
			.style("height",typeH-4*marg+"px")
			.style("padding",2*marg+"px")
			.text("FrÃ©quentations")
		var panel = div.append("div").attr("id","panel")
			.style("top",panelH+"px")
			.style("width",panelW+"px");
		var stationname = div.append("div").attr("id","stationname")
			.style("top",panelH+"px")
			.style("width",panelW-4*marg+"px")
			.style("padding",2*marg+"px")
			.text("Please select a station");
		var stationgrams = div.append("div").attr("id","stationgrams")
			.style("top",panelH+7*marg+"px")
			.style("width",panelW-2*marg+"px")
			.style("padding",marg+"px");
		var overimage = div.append("img").attr("id","overCarresImage")
			.attr("src","data/buttons-01.png")
			.style("top",cY-imSize/2+"px")
			.style("left",cX-imSize/2+"px")
			.style("width",imSize+"px");
					
		g = svgmap.append("g");
		var gvoronoi = g.append("g");
		
		var myc = null;
		var voronoi = null;
		var mydata = null;
		var stats = [];
		var scales = [];

		var gcarres = svgmap.append("g")
			.attr("class",'carres')
			.attr("transform", "translate(" + cX + "," + cY + ")");
		var tobuild = [
			{'ang':0,'typ':'HF','color':'#A8D7FB'},
			{'ang':90,'typ':'FH','color':'#FBBCBC'},
			{'ang':180,'typ':'FF','color':'#FBBCBC'},
			{'ang':270,'typ':'HH','color':'#A8D7FB'},
		];
		gcarres.append("svg:rect")
			.attr("class","carres_back")
			.attr("x",-baseR-masR)
			.attr("y",-baseH)
			.attr("width",2*(baseR+masR))
			.attr("height",2*(baseH))
			.on("mouseover",function(){
				d3.selectAll(".carres_value").attr("width",baseR);
				d3.selectAll(".carres_value").attr("height",baseR);
			});
		tobuild.forEach(function(u) {
			gcarres.append("svg:rect")
				.attr("class","carres_value")
				.attr("id","value_"+u.typ)
				.attr("x",0)
				.attr("y",0)
				.attr("width",baseR)
				.attr("height",baseR)
				.attr("transform","rotate("+u.ang+")")
				.attr("fill","#e3e3e3");//u.color);
			gcarres.append("svg:rect")
				.attr("x",0)
				.attr("y",0)
				.attr("width",baseR)
				.attr("height",baseR)
				.attr("transform","rotate("+u.ang+")")
				.attr("fill","white")
			gcarres.append("svg:rect")
				.attr("class","clic carres_clic clic_"+u.typ)
				.attr("x",0)
				.attr("y",0)
				.attr("width",baseR)
				.attr("height",baseR)
				.attr("transform","rotate("+u.ang+")")
				.attr("fill",u.color)
				.on("click",function(){
					f.switchMode(u.typ);
				});
		});
		gcarres.append("svg:line")
			.attr("x1",0)
			.attr("x2",0)
			.attr("y1",-baseR)
			.attr("y2",baseR)
			.style("stroke","black")
			.style("stroke-width",3)
		gcarres.append("svg:circle")
			.attr("class","clic carres_circle current clic_TOTAL")
			.attr("cx",0)
			.attr("cy",0)
			.attr("r",baseR/3)
			.on("click",function(){
				f.switchMode('TOTAL');
			})
		
		/////////////////////////////////////////////////////////////////////////////////////////////////////////
		// switch to mode
		f.switchMode = function(mode) {
			d3.selectAll(".clic").classed("current",false);
			d3.select(".clic_"+mode).classed("current",true);
			d3.select("#typename").text(stats["types"][mode]);
			var col = mode[0]=="H" ? "blue" : "red";
			if(mode=="TOTAL") col="green";
			var scale = d3.scale.linear().domain([0,stats['max'+mode]]).range(["white",col]);;
			gvoronoi.selectAll("path")
				.transition()
				.duration(500)
				.attr("fill", function(d,i){
					var val = d3.select(this).attr(mode);
					return scale( val );
				});		
		}
		
		/////////////////////////////////////////////////////////////////////////////////////////////////////////
		// update tag cloud from array
		f.updateNgrams = function(words) {
			words = eval('('+words+')');
			//console.log(words);
			d3.selectAll(".ngrams").remove();
			var maxCount = Math.max.apply(Math,words.map(function(y){return y.count;}));
			var scale = d3.scale.linear().domain([2,maxCount]).range([minNgramSize,maxNgramSize]);
			d3.select("#stationgrams").selectAll("grams")
				.data(words)
				.enter().append("div")
					.attr("class","ngrams")
					.text(function(d){return d.word;})
					.style("font-size",function(d){return scale(d.count)+"px";});
		};
		
		/////////////////////////////////////////////////////////////////////////////////////////////////////////			
		// Use Leaflet to implement a D3 geographic projection.
		f.project = function(x) {
			var point = f.map.locationPoint({ lat:x[1],lon:x[0] });
			return [point.x, point.y];
		}
		
		/////////////////////////////////////////////////////////////////////////////////////////////////////////
		// Reposition the SVG to cover the features.
		f.draw = function() {
			//console.log("draw");
			
			var bounds = f.map.extent(),
					bl = bounds.southWest(),
					tr = bounds.northEast();
			var bottomLeft = f.project([bl.lon, bl.lat]),
					topRight = f.project([tr.lon, tr.lat]);
				
			svgmap.attr("width", topRight[0] - bottomLeft[0])
					.attr("height", bottomLeft[1] - topRight[1])
					.style("margin-left", bottomLeft[0] + "px")
					.style("margin-top", topRight[1] + "px");
	
			g.attr("transform", "translate(" + -bottomLeft[0] + "," + -topRight[1] + ")");
				
			var pp = f.project([48.866296,2.320124]);
			myc.attr("cx",function(d,i){return f.project([parseFloat(d.x),parseFloat(d.y)])[0];})
				.attr("cy",function(d,i){return f.project([parseFloat(d.x),parseFloat(d.y)])[1];});
			
			var dataPositions = mydata.map(function(d,i){ return [f.project([parseFloat(d.x),parseFloat(d.y)])[0],f.project([parseFloat(d.x),parseFloat(d.y)])[1]];});
			var ndata = d3.geom.voronoi(dataPositions).map(function(d) { return "M" + d.join("L") + "Z"; });
			g.selectAll("path")
				.data(ndata)
				//.filter(function(d) { return this.getAttribute("d") != d; })
				.attr("d", function(d) { return d; });
		}
		
		/////////////////////////////////////////////////////////////////////////////////////////////////////////
		// init
		f.data = function(indata,m) {
			stats['types'] = {}
			stats['types']['HF'] = 'Homme > Femme';
			stats['types']['FH'] = 'Femme > Homme';
			stats['types']['HH'] = 'Homme > Homme';
			stats['types']['FF'] = 'Femme > Femme';
			stats['types']['TOTAL'] = 'Toutes annonces';
			stats['minFreq'] = Math.min.apply(Math,indata.map(function(y){ return y.trafic ; }));
			stats['maxFreq'] = Math.max.apply(Math,indata.map(function(y){ return y.trafic ; }));
			stats['coefFreq'] = stats['maxFreq']/stats['minFreq'];
			// less visited station got multiplyed by how many less visitors it got from the most visited
			stats['scaleFreq'] = d3.scale.linear()
				.domain([stats['minFreq'],stats['maxFreq']])
				.range([stats['coefFreq'],1]);
			
			['HF','FH','HH','FF','TOTAL'].forEach(function(u){
				stats['max'+u] = Math.max.apply(Math,indata.map(function(y){
					return y[u+' 2'] * stats['scaleFreq'](y.trafic) ;
				}));
			});
			console.log(stats);
			mydata = indata ;
			f.map = m;
			//console.log(f);
			
			var maxCount = d3.max(indata,function(d,i){return parseInt(d['TOTAL 3']);});
			var opScale = d3.scale.linear() // for opacity, non representative values are transparent
				.domain([0,maxCount])
				.range([0,1]);
			
			var pointScale = d3.scale.linear()
				.domain([stats['minFreq'],stats['maxFreq']])
				.range([minPointSize,maxPointSize]);
			myc = gvoronoi.selectAll('station')
				.data(mydata)
				.enter().append("svg:circle")
				.attr("name",function(d,i){return d.station;})
				.attr("class",'stations')
				.attr("cx",function(d,i){return f.project([parseFloat(d.x),parseFloat(d.y)])[0];})
				.attr("cy",function(d,i){return f.project([parseFloat(d.x),parseFloat(d.y)])[1];})
				.attr("r",function(d,i){return pointScale(d.trafic); });
			
			/////////////////////////////////////////// VORONOI
			// friendly array for d3 voronoi
			var dataPositions = indata.map(function(d,i){ return [f.project([parseFloat(d.x),parseFloat(d.y)])[0],f.project([parseFloat(d.x),parseFloat(d.y)])[1]];});
			voronoi = gvoronoi.selectAll("path")
				.data(d3.geom.voronoi(dataPositions))
				.enter().append("svg:path")
					.attr("class","voropaths")
					//.attr("fill","gray") //function(d,i){return colScale(indata[i].total);})
					//.style("opacity",function(d,i){ return opScale(indata[i].total);})
					.attr("station",function(d,i){return indata[i].name;})
					.attr("TOTAL",function(d,i){return indata[i]['TOTAL 2'] * stats['scaleFreq'](indata[i].trafic) ;})
					.attr("FF",function(d,i){return indata[i]['FF 2'] * stats['scaleFreq'](indata[i].trafic) ;})
					.attr("FH",function(d,i){return indata[i]['FH 2'] * stats['scaleFreq'](indata[i].trafic) ;})
					.attr("HF",function(d,i){return indata[i]['HF 2'] * stats['scaleFreq'](indata[i].trafic) ;})
					.attr("HH",function(d,i){return indata[i]['HH 2'] * stats['scaleFreq'](indata[i].trafic) ;})
					.attr("fill", function(d,i){
						var scale = d3.scale.linear().domain([stats['minFreq'],stats['maxFreq']]).range(["white","green"]);
						return scale( indata[i].trafic );
					})
					.attr("d", function(d,i) { return "M" + d.join("L") + "Z"; })
						.on("click",function(d,i){
							f.updateNgrams(indata[i].ngrams);
						})
						.on("mouseover",function(d,i){
							f.updateNgrams(indata[i].ngrams);
							var thePath = d3.select(this);
							//thePath.style("opacity",0.8);
							//thePath.attr("fill","yellow");
							d3.select("#stationname").text( indata[i].name );
							['HF','FH','HH','FF'].forEach(function(u){
								var vl = thePath.attr(u);
								var scale = d3.scale.pow().exponent(.6).domain([0,stats['max'+u]]).range([baseR,baseR+masR]);
								//var scale = d3.scale.linear().domain([0,stats['max'+u]]).range([baseR,baseR+masR]);
								d3.select("#value_"+u).transition().duration(90)
									.attr(u[1]=="H" ? "height" : "width",scale(vl));
									//.attr("height",scale(vl));
							});
						})
					.append("title").text(function(d,i){
						var tit = indata[i].name +"\ntrafic="+indata[i].trafic+" ("+stats['scaleFreq'](indata[i].trafic)+")";
						['HF','FH','HH','FF','TOTAL'].forEach(function(u) {
							tit += "\n" + u + "=" + indata[i][u+' 2'];
						});
						return tit;
					});
			return f;
		};
		return f;
}
 
	/////////////////////////////////////////////////////////////////////////////////////////////////////////
	m = mapbox.map('map');
	var backLayer = mapbox.layer().id('minut.map-tno4o0kc');
	m.addLayer(backLayer);
	var dimensions = m.dimensions;
	m.parent.className += ' map-fullscreen-map';
	document.body.className += ' map-fullscreen-view';
	m.dimensions = { x: m.parent.offsetWidth, y: m.parent.offsetHeight };
	m.draw();
	m.center({lat:48.83,lon:2.39});
	m.zoom(12,true);
	
	
	d3.tsv("data/annonces.tsv", function(data) {
		var l = folly().data(data,m);
		m.addLayer(l);
		$(window).keydown(function(event) {
			if(event.keyCode==90) l.switchMode('HH');
			if(event.keyCode==65) l.switchMode('FF');
			if(event.keyCode==81) l.switchMode('FH');
			if(event.keyCode==83) l.switchMode('HF');
		});
	});
	
</script>
</body>
</html>